## Configuration
#
# The Config is a simple config-by-environment mechanism. It's only one level deep:
# basically a list of default settings that can be overridden for each environment,
# and some regexes for detecting the environment in which we are running.

# TODO make this configurable at the rails application level

class Cms.Config
  defaults: 
    mount_point: "/cms/pages"
    api_url: "<%= Chemistry.api_url %>"
    cookie_domain: "<%= Chemistry.cookie_domain %>"
    logging: false
    log_level: 'debug'
    trap_errors: false
    display_errors: false
    badger_errors: false

  production:
    trap_errors: true
    badger_errors: true

  staging:
    logging: true
    log_level: 'info'
    trap_errors: true
    display_errors: true

  development:
    logging: true
    display_errors: true
    trap_errors: false

  constructor: (options={}) ->
    @_environment = options.environment ? @guessEnvironment()
    @_settings = _.defaults options, @[@_environment], @defaults

  guessEnvironment: () ->
    stag = new RegExp(/<%= Chemistry.staging_host %>/)
    dev = new RegExp(/<%= Chemistry.dev_host %>/)
    href = window.location.href
    if stag.test(href)
      "staging"
    else if dev.test(href)
      "development"
    else
      "production"

   settings: =>
     @_settings

   get: (key) =>
    @_settings[key]

   set: (key, value) =>
    @_settings[key] = value

  environment: =>
    @_environment ?= @guessEnvironment()

  logLevel: =>
    @_settings['log_level'] ? 'info'

  apiUrl: =>
    @get('api_url')

  initUrl: =>
    [@get('api_url'), 'pages/site'].join('/')
