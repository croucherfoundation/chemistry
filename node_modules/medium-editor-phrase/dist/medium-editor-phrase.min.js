var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};!function(e,t){"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports=t:"function"==typeof define&&define.amd?define(t):e.MediumEditorPhrase=t}(this,function(e){function t(e){return e.split(s).join("")}function n(e){for(var t=1,n=e.parentNode.firstChild;n!==e;)t+=1,n=n.nextSibling;return t}var s="safariNeedsTextNode!@#$%^()*~",r='<div data-phrase-placeholder="true"></div>',i='div[data-phrase-placeholder="true"]';return e.extensions.button.extend({phraseTagName:"span",phraseClassList:[],name:"phrase",contentDefault:"S",aria:"Span Button",classList:[],init:function(){e.Extension.prototype.init.apply(this,arguments),this.useQueryState=!1,this.phraseHasNoClass=0===this.phraseClassList.length,this.phraseSelector=this.phraseTagName+this.phraseClassList.reduce(function(e,t){return e+"."+t},""),this.openingTag="<"+this.phraseTagName+(this.phraseHasNoClass?"":' class="'+this.phraseClassList.join(" ").trim()+'"')+">",this.closingTag="</"+this.phraseTagName+">",this.button=this.createButton(),this.on(this.button,"click",this.handleClick.bind(this))},cloneSelection:function(){var t=e.selection.getSelectionRange(this.document),n=document.createElement("div");return n.appendChild(t.cloneContents()),n},isPhraseNode:function(e){return!(!e||e.tagName.toLowerCase()!==this.phraseTagName||(this.phraseHasNoClass?e.className:!this.phraseClassList.reduce(function(t,n){return t&&e.classList.contains(n)},!0)))},removePhraseTags:function(e){e.outerHTML=e.innerHTML},addPhraseTags:function(e){var t="",n="";return e=e.replace(/^(<\/[^>]+>)*/,function(e){return t=e,""}).replace(/(<[^\/>]+>)*$/,function(e){return n=e,""}),e&&(e=this.openingTag+e+this.closingTag),t+e+n},getSelectionPhrases:function(e){var t=Array.prototype.slice.call(e.querySelectorAll(this.phraseSelector));return this.phraseHasNoClass&&(t=t.filter(function(e){return!e.className})),t},replaceSelectionHtml:function(t,n){var s,r=e.selection.getSelectionRange(this.document),i=this.document.getSelection();r.deleteContents(),s=r.createContextualFragment(t),r.insertNode(s),i.removeAllRanges(),n!==!1&&(s.firstChild&&(r.setStartBefore(s.firstChild),r.setEndAfter(s.lastChild)),i.addRange(r))},getNodeHtml:function(e){switch(e.nodeType){case Node.ELEMENT_NODE:return e.innerHTML;case Node.TEXT_NODE:return e.textContent;default:return e.innerHTML||e.textContent||""}},isAlreadyApplied:function(){return this.hasSelectionPhrase()||!!this.getAncestorPhrase()},insertTextNodePlaceholder:function(e,t){return e.parentNode.insertBefore(this.document.createTextNode(s),t?e.nextSibling:e)},insertTextNodePlaceholderBefore:function(e){return this.insertTextNodePlaceholder(e)},insertTextNodePlaceholderAfter:function(e){return this.insertTextNodePlaceholder(e,!0)},removeAncestorPhrase:function(e){var t,n,s=this,o=e.parentNode,a=this.getNodeHtml(this.cloneSelection()),l=this.document.getSelection(),h=this.document.createRange();return this.replaceSelectionHtml(r,!1),e.outerHTML=e.cloneNode(!0).innerHTML.split(r).map(function(e){return e&&s.addPhraseTags(e)}).join(r),l.removeAllRanges(),t=o.querySelector(i),n=this.insertTextNodePlaceholderAfter(t),t.parentNode.removeChild(t),h.selectNode(n),l.addRange(h),a},isLastDescendantTextNode:function(e,t){for(var n,s,r=!0,i=this.document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1);n=i.nextNode()&&r;)s&&(r=!1),n===e&&(s=!0);return r},isFirstDescendantTextNode:function(e,t){var n=this.document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1).firstChild();return e===n},ensurePhraseSelected:function(){var t,s,r=this.window.getSelection(),i=e.selection.getSelectionRange(this.document),o=i.startContainer,a=i.startOffset,l=i.endContainer,h=i.endOffset,c=l!==o,d=l.nodeType===Node.TEXT_NODE&&h===l.textContent.length,u=o.nodeType===Node.TEXT_NODE&&0===a,f=this.document.createRange();c&&(d&&(t=e.util.traverseUp(l,this.isPhraseNode.bind(this)),t&&this.isLastDescendantTextNode(l,t)&&(s=this.insertTextNodePlaceholderAfter(t),f.setStart(o,a),f.setEnd(s.parentNode,n(s)))),u&&(t=e.util.traverseUp(o,this.isPhraseNode.bind(this)),t&&this.isFirstDescendantTextNode(o,t)&&(f.setStart(this.insertTextNodePlaceholderBefore(t),0),s||f.setEnd(l,h))),f.collapsed||(r.removeAllRanges(),r.addRange(f)))},togglePhraseTags:function(){var e,n,s;return this.ensurePhraseSelected(),e=this.cloneSelection(),n=this.getSelectionPhrases(e),s=e.innerHTML,n.length?(n.forEach(this.removePhraseTags),s=e.innerHTML):e.textContent&&(s=this.addPhraseTags(s)),t(s)},hasSelectionPhrase:function(){return this.getSelectionPhrases(this.cloneSelection()).length>0},getAncestorPhrase:function(){return e.util.traverseUp(e.selection.getSelectionRange(this.document).startContainer,this.isPhraseNode.bind(this))},handleClick:function(e){var t=this.getAncestorPhrase();e.preventDefault(),e.stopPropagation(),this.replaceSelectionHtml(!t||this.hasSelectionPhrase()?this.togglePhraseTags():this.removeAncestorPhrase(t)),this.isAlreadyApplied()?this.setActive():this.setInactive(),this.base.checkContentChanged()}})}("function"==typeof require?require("medium-editor"):MediumEditor));